<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Kil√≥metros</title>

<!-- ================== ESTILOS ================== -->
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Segoe UI',Tahoma,Verdana,sans-serif;
    background:#f3f4f6;
    color:#1f2937;
}

nav{
    background:#1f2937;
    padding:15px 30px;
    display:flex;
    gap:20px;
    align-items:center;
}
nav a{
    color:#fff;
    text-decoration:none;
    font-weight:600;
}
nav a:first-child{
    color:#84cc16;
    font-weight:800;
}

.content{padding:30px}

header{
    background:linear-gradient(135deg,#1f2937,#374151);
    padding:25px;
    border-radius:14px;
    margin-bottom:20px;
}
header h1{color:#84cc16}
.subtitle{color:#d1d5db}

.filter-bar select{
    padding:10px;
    border-radius:8px;
    border:2px solid #e5e7eb;
    font-weight:600;
}

.kpi-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:16px;
    margin:25px 0;
}
.kpi-card{
    background:#fff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:18px;
}
.kpi-card.highlight{border-left:5px solid #84cc16}
.kpi-card.warning{border-left:5px solid #ef4444}
.kpi-label{font-size:11px;font-weight:700;color:#6b7280}
.kpi-value{font-size:26px;font-weight:800;margin-top:8px}

.chart-container{
    background:#fff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:20px;
    margin-bottom:25px;
}

table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
}
th,td{
    padding:8px;
    border-bottom:1px solid #e5e7eb;
}
th{background:#f9fafb}
</style>
</head>

<body>

<!-- ================== MEN√ö ================== -->
<nav>
  <a href="index.html">üöõ Traxion</a>
  <a href="dashboard_kilometros.html">üìä Kil√≥metros</a>
  <a href="dashboard_flota.html">üöó Flota</a>
  <a href="dashboard_scoreseg.html">üõ°Ô∏è ScoreSeg</a>
</nav>

<div class="content">

<header>
  <h1>Dashboard de Kil√≥metros</h1>
  <p class="subtitle" id="headerPeriodo">Cargando datos‚Ä¶</p>
</header>

<div class="filter-bar">
  <select id="unidadNegocio">
    <option value="SETTEPI SALTILLO">SETTEPI SALTILLO</option>
    <option value="LIPU SALTILLO">LIPU SALTILLO</option>
  </select>
</div>

<div class="kpi-grid">
  <div class="kpi-card highlight">
    <div class="kpi-label">Total KM</div>
    <div class="kpi-value" id="kpiTotal">0</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">KM Servicio</div>
    <div class="kpi-value" id="kpiServicio">0</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">KM Mtto</div>
    <div class="kpi-value" id="kpiMtto">0</div>
  </div>
  <div class="kpi-card warning">
    <div class="kpi-label">KM Vac√≠o</div>
    <div class="kpi-value" id="kpiVacio">0</div>
  </div>
</div>

<div class="chart-container">
  <h3>Detalle por Cliente</h3>
  <table>
    <thead>
      <tr>
        <th>UDN</th>
        <th>Gerente</th>
        <th>Cliente</th>
        <th>KM Total</th>
        <th>KM Vac√≠o</th>
      </tr>
    </thead>
    <tbody id="tablaDetalle"></tbody>
  </table>
</div>

</div>

<!-- ================== LIBRER√çAS ================== -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- ================== SCRIPT ================== -->
<script>
const SHEET_ID = "1l3QYg7N050BScrtNhKkHQ-hHNDgaK9Prw95Dzb2-DRE";
const SHEET_NAME = "Kilometros";

function num(v){
  if(!v) return 0;
  return Number(v.toString().replace(/[$,]/g,'')) || 0;
}

async function cargarDatos(){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=${SHEET_NAME}`;
  const res = await fetch(url);
  const csv = await res.text();
  return new Promise(r=>{
    Papa.parse(csv,{header:false,skipEmptyLines:true,complete:x=>r(x.data)});
  });
}

async function actualizar(){
  const unidad = document.getElementById('unidadNegocio').value;
  const rows = await cargarDatos();

  let total=0, serv=0, mtto=0, vacio=0;
  let html="";

  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(!r || !r[0]) continue;

    const udn = r[0].toUpperCase();
    if(unidad.includes("SETTEPI") && !udn.includes("SETTEPI")) continue;
    if(unidad.includes("LIPU") && !udn.includes("LIPU")) continue;

    total += num(r[4]);
    serv  += num(r[5]);
    mtto  += num(r[6]);
    vacio += num(r[7]);

    html += `
      <tr>
        <td>${r[0]}</td>
        <td>${r[1]}</td>
        <td>${r[3]}</td>
        <td style="text-align:right">${num(r[4]).toLocaleString()}</td>
        <td style="text-align:right;color:#dc2626">${num(r[7]).toLocaleString()}</td>
      </tr>`;
  }

  kpiTotal.innerText = total.toLocaleString()+" km";
  kpiServicio.innerText = serv.toLocaleString()+" km";
  kpiMtto.innerText = mtto.toLocaleString()+" km";
  kpiVacio.innerText = vacio.toLocaleString()+" km";

  tablaDetalle.innerHTML = html || `<tr><td colspan="5" style="text-align:center">Sin datos</td></tr>`;
  headerPeriodo.innerText = unidad;
}

document.getElementById('unidadNegocio').addEventListener('change', actualizar);
document.addEventListener('DOMContentLoaded', actualizar);
</script>

</body>
</html>
