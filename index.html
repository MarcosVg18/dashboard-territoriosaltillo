<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Traxion</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f3f4f6;color:#1f2937;display:flex}
.sidebar{width:260px;background:#1f2937;min-height:100vh;padding:25px 20px}
.sidebar h2{color:#84cc16;text-align:center;margin-bottom:30px}
.menu-item{padding:14px 18px;border-radius:10px;margin-bottom:12px;color:#d1d5db;font-weight:600;cursor:pointer}
.menu-item.active{background:#84cc16;color:#1f2937}
.content{flex:1;padding:30px}
.container{max-width:1600px;margin:auto}
header{background:linear-gradient(135deg,#1f2937,#374151);padding:30px;border-radius:14px;margin-bottom:14px}
header h1{color:#84cc16;font-size:32px}
.subtitle{color:#d1d5db;margin-top:6px}
.filter-bar{margin:10px 0 18px 0}
.filter-bar select{padding:10px 14px;border-radius:10px;border:2px solid #e5e7eb;font-size:14px;font-weight:600;min-width:220px}
.kpi-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:16px}
.kpi-card{background:#fff;border:2px solid #e5e7eb;border-radius:12px;padding:16px}
.kpi-card.highlight{border-left:4px solid #84cc16}
.kpi-card.warning{border-left:4px solid #f59e0b}
.kpi-label{font-size:11px;font-weight:600;color:#6b7280;text-transform:uppercase}
.kpi-value{font-size:22px;font-weight:700}
.kpi-value.highlight{color:#84cc16}
.kpi-subvalue{font-size:11px;color:#9ca3af}
.charts-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px}
.chart-box{background:#fff;border:2px solid #e5e7eb;border-radius:14px;padding:14px}
</style>
</head>

<body>

<aside class="sidebar">
<h2>Traxion</h2>
<div class="menu-item active" id="menu-km">üöõ Kil√≥metros</div>
<div class="menu-item" id="menu-flota">üöó Flota Vehicular</div>
<div class="menu-item" id="menu-dif">üìä Diferencia km Cargas vs GPS</div>
</aside>

<main class="content"><div class="container">

<!-- ================= KILOMETROS ================= -->
<section id="view-kilometros">
<header>
<h1>Dashboard de Kil√≥metros Recorridos</h1>
<p class="subtitle" id="headerPeriodo"></p>
</header>

<div class="filter-bar">
<select id="unidadNegocio">
<option value="SETTEPI SALTILLO">SETTEPI SALTILLO</option>
<option value="LIPU SALTILLO">LIPU SALTILLO</option>
</select>
</div>

<div class="kpi-grid">
<div class="kpi-card highlight"><div class="kpi-label">TOTAL KM</div><div class="kpi-value highlight" id="kpiTotal">0</div><div class="kpi-subvalue">Acumulado</div></div>
<div class="kpi-card"><div class="kpi-label">KM PERMITIDOS</div><div class="kpi-value" id="kpiPermitido">0</div></div>
<div class="kpi-card highlight"><div class="kpi-label">MARGEN</div><div class="kpi-value highlight" id="kpiMargen">0</div><div class="kpi-subvalue"></div></div>
<div class="kpi-card"><div class="kpi-label">SERVICIO</div><div class="kpi-value" id="kpiServicio">0</div><div class="kpi-subvalue" id="pctServicio"></div></div>
<div class="kpi-card"><div class="kpi-label">MTTO</div><div class="kpi-value" id="kpiMtto">0</div><div class="kpi-subvalue" id="pctMtto"></div></div>
<div class="kpi-card warning"><div class="kpi-label">VAC√çO</div><div class="kpi-value" id="kpiVacio">0</div><div class="kpi-subvalue" id="pctVacio"></div></div>
</div>

<div class="charts-grid">
<div class="chart-box"><canvas id="chartDistribucion"></canvas></div>
<div class="chart-box"><canvas id="chartPermitido"></canvas></div>
<div class="chart-box"><canvas id="chartEficiencia"></canvas></div>
</div>
</section>

<!-- ================= DIFERENCIA ================= -->
<section id="view-dif" style="display:none">
<header>
<h1>Diferencia KM Cargas vs GPS</h1>
<p class="subtitle" id="headerPeriodoDif"></p>
</header>

<div class="filter-bar">
<select id="unidadNegocioDif"></select>
</div>

<div class="kpi-grid">
<div class="kpi-card highlight"><div class="kpi-label">TOTAL KM GPS</div><div class="kpi-value highlight" id="kpiGps">0</div></div>
<div class="kpi-card"><div class="kpi-label">TOTAL KM CARGAS</div><div class="kpi-value" id="kpiCargas">0</div></div>
<div class="kpi-card highlight"><div class="kpi-label">DIFERENCIA TOTAL</div><div class="kpi-value highlight" id="kpiDif">0</div><div class="kpi-subvalue" id="kpiDifPct"></div></div>
<div class="kpi-card warning"><div class="kpi-label">CARROS CON DIF &lt; -1000</div><div class="kpi-value" id="kpiCriticos">0</div></div>
</div>
</section>

</div></main>

<script>
const SHEET_ID="1l3QYg7N050BScrtNhKkHQ-hHNDgaK9Prw95Dzb2-DRE";
const SHEET_KM="Kilometros";
const SHEET_DIF="KM Dif Cargas vs GPS";

function num(v){return Number((v||"0").toString().replace(/,/g,""))||0}

/* ===== MENU ===== */
menuKm.onclick=()=>show("view-kilometros",menuKm);
menuFlota.onclick=()=>show("view-flota",menuFlota);
menuDif.onclick=()=>{show("view-dif",menuDif);cargarDif()};

function show(view,menu){
document.querySelectorAll("section").forEach(s=>s.style.display="none");
document.querySelectorAll(".menu-item").forEach(m=>m.classList.remove("active"));
document.getElementById(view).style.display="block";
menu.classList.add("active");
}

/* ===== DIF ===== */
async function cargarDif(){
const csv=await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=${SHEET_DIF}`).then(r=>r.text());
Papa.parse(csv,{header:true,complete:r=>{
const rows=r.data;
const udns=[...new Set(rows.map(x=>x.UDN).filter(Boolean))];
unidadNegocioDif.innerHTML="";
udns.forEach(u=>unidadNegocioDif.innerHTML+=`<option>${u}</option>`);
unidadNegocioDif.value=udns[0];
unidadNegocioDif.onchange=()=>actualizarDif(rows);
actualizarDif(rows);
}});
}

function actualizarDif(rows){
let gps=0,cargas=0,crit=new Set();
rows.forEach(r=>{
if(r.UDN===unidadNegocioDif.value){
const g=num(r["KM GPS"]);
const c=num(r["KM CARGAS"]);
gps+=g;cargas+=c;
if(g-c<-1000)crit.add(r.IDS);
}});
kpiGps.innerText=gps.toLocaleString()+" km";
kpiCargas.innerText=cargas.toLocaleString()+" km";
kpiDif.innerText=(gps-cargas).toLocaleString()+" km";
kpiDifPct.innerText=((gps-cargas)/cargas*100).toFixed(2)+"% sobre KM CARGAS";
kpiCriticos.innerText=crit.size;
}
</script>

</body>
</html>
