<script>
const SHEET_ID = "1l3QYg7N050BScrtNhKkHQ-hHNDgaK9Prw95Dzb2-DRE";
const SHEET_NAME = "Kilometros";

function num(v){
    if(!v) return 0;
    return Number(v.toString().replace(/,/g,"").trim()) || 0;
}

async function cargarDatos(){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=${SHEET_NAME}`;
    const res = await fetch(url);
    const csv = await res.text();
    return new Promise(r=>{
        Papa.parse(csv,{header:false,skipEmptyLines:true,complete:x=>r(x.data)});
    });
}

let chartProgreso, chartPie, chartLineas;

async function actualizar(){
    const unidad = unidadNegocio.value.trim().toUpperCase();
    const rows = await cargarDatos();

    let total=0, servicio=0, mtto=0, vacio=0, permitidoTotal=0;
    let datosDiarios = [];
    let tablaMap = {};

    const hoy = new Date(); hoy.setDate(hoy.getDate()-1);

    rows.forEach(r=>{
        const udnMaestro = (r[0]||"").trim().toUpperCase();

        /* ====== KPIs (ACUMULADO GENERAL) ====== */
        if(udnMaestro===unidad){
            total += num(r[4]);
            servicio += num(r[5]);
            mtto += num(r[6]);
            vacio += num(r[7]);
            permitidoTotal += num(r[9]);
        }

        /* ====== DATOS DIARIOS (GRAFICA 1 Y 3) ====== */
        const diaSettepi = num(r[12]);
        const diaLipu = num(r[20]);

        if(unidad==="SETTEPI SALTILLO" && diaSettepi>=1 && diaSettepi<=hoy.getDate()){
            datosDiarios.push({
                dia: diaSettepi,
                kmTotal: num(r[13]),
                kmServ: num(r[14]),
                kmMtto: num(r[15]),
                kmVac: num(r[16]),
                kmPermitidoDia: num(r[17]),
                gerente:r[1], jefe:r[2], cliente:r[3]
            });
        }

        if(unidad==="LIPU SALTILLO" && diaLipu>=1 && diaLipu<=hoy.getDate()){
            datosDiarios.push({
                dia: diaLipu,
                kmTotal: num(r[21]),
                kmServ: num(r[22]),
                kmMtto: num(r[23]),
                kmVac: num(r[24]),
                kmPermitidoDia: num(r[25]),
                gerente:r[1], jefe:r[2], cliente:r[3]
            });
        }
    });

    /* ====== ORDENAR POR DÍA ====== */
    datosDiarios.sort((a,b)=>a.dia-b.dia);

    /* ====== ACUMULADOS PARA GRÁFICA 1 ====== */
    let realAc=0, perAc=0;
    let labels=[], realData=[], perData=[];

    datosDiarios.forEach(d=>{
        realAc += d.kmTotal;
        perAc += d.kmPermitidoDia;

        labels.push(d.dia);
        realData.push(realAc);
        perData.push(perAc);

        /* ====== TABLA (SOLO UDN FILTRADA) ====== */
        const key = d.gerente+"|"+d.jefe+"|"+d.cliente;

        if(!tablaMap[key]){
            tablaMap[key]={gerente:d.gerente,jefe:d.jefe,cliente:d.cliente,
                           rec:0,serv:0,mtto:0,ine:0};
        }
        tablaMap[key].rec += d.kmTotal;
        tablaMap[key].serv += d.kmServ;
        tablaMap[key].mtto += d.kmMtto;
        tablaMap[key].ine += d.kmVac;
    });

    /* ====== KPIs (YA CORRECTOS) ====== */
    kpiTotal.innerText = total.toLocaleString()+" km";
    kpiServicio.innerText = servicio.toLocaleString()+" km";
    kpiMtto.innerText = mtto.toLocaleString()+" km";
    kpiVacio.innerText = vacio.toLocaleString()+" km";
    kpiPermitido.innerText = permitidoTotal.toLocaleString()+" km";

    const margen = permitidoTotal - total;
    kpiMargen.innerText = margen.toLocaleString()+" km";

    const pct = permitidoTotal?((margen/permitidoTotal)*100).toFixed(1):0;
    const importe = (margen*6).toLocaleString("es-MX",{style:"currency",currency:"MXN"});
    txtMargen.innerHTML = `${pct}% de los KM permitidos.<br>Y en importe es: ${importe}`;

    headerPeriodo.innerText = "Periodo al día "+hoy.getDate();

    /* ====== GRAFICA 1 (YA FUNCIONA) ====== */
    if(chartProgreso) chartProgreso.destroy();
    chartProgreso = new Chart(document.getElementById("chartProgreso"),{
        type:"line",
        data:{labels,
            datasets:[
            {label:"KM Real Acumulado",data:realData,borderColor:"#84cc16"},
            {label:"KM Permitido Acumulado",data:perData,borderColor:"#1f2937"}
        ]}
    });

    /* ====== PIE ====== */
    const totalPie = servicio+mtto+vacio;
    const pServ = totalPie?((servicio/totalPie)*100).toFixed(1):0;
    const pMtto = totalPie?((mtto/totalPie)*100).toFixed(1):0;
    const pVac  = totalPie?((vacio/totalPie)*100).toFixed(1):0;

    if(chartPie) chartPie.destroy();
    chartPie = new Chart(document.getElementById("chartPie"),{
        type:"pie",
        data:{
            labels:[
              `Servicio ${pServ}%`,
              `Mtto ${pMtto}%`,
              `Vacío ${pVac}%`
            ],
            datasets:[{
                data:[servicio,mtto,vacio],
                backgroundColor:["#84cc16","#9ca3af","#f59e0b"]
            }]
        }
    });

    /* ====== LINEAS ====== */
    if(chartLineas) chartLineas.destroy();
    chartLineas = new Chart(document.getElementById("chartLineas"),{
        type:"line",
        data:{
            labels,
            datasets:[
                {label:"Servicio",data:datosDiarios.map(d=>d.kmServ),borderColor:"#84cc16"},
                {label:"Mtto",data:datosDiarios.map(d=>d.kmMtto),borderColor:"#9ca3af"},
                {label:"Vacío",data:datosDiarios.map(d=>d.kmVac),borderColor:"#f59e0b"}
            ]
        }
    });

    /* ====== TABLA FINAL (SOLO UDN FILTRADA) ====== */
    let tabla = Object.values(tablaMap).map(r=>{
        let pctVac = r.rec? (r.ine/r.rec*100) : 0;
        return {...r, pctVac};
    });

    tabla.sort((a,b)=> b.pctVac - a.pctVac);

    const body = document.getElementById("tablaConsolidada");
    body.innerHTML="";

    tabla.forEach(r=>{
        body.innerHTML += `
        <tr>
          <td>${r.gerente}</td>
          <td>${r.jefe}</td>
          <td>${r.cliente}</td>
          <td>${r.rec.toLocaleString()}</td>
          <td>${r.serv.toLocaleString()}</td>
          <td>${r.mtto.toLocaleString()}</td>
          <td>${r.ine.toLocaleString()}</td>
          <td>${r.pctVac.toFixed(2)}%</td>
        </tr>`;
    });
}

unidadNegocio.addEventListener("change",actualizar);
actualizar();
</script>
