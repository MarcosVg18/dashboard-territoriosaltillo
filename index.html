<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Traxion</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:#f3f4f6;
    color:#1f2937;
    display:flex;
}

.sidebar{
    width:260px;
    background:#1f2937;
    min-height:100vh;
    padding:25px 20px;
}
.sidebar h2{
    color:#84cc16;
    text-align:center;
    margin-bottom:30px;
}
.menu-item{
    padding:14px 18px;
    border-radius:10px;
    margin-bottom:12px;
    color:#d1d5db;
    font-weight:600;
    cursor:pointer;
}
.menu-item.active{
    background:#84cc16;
    color:#1f2937;
}

.content{flex:1;padding:30px;}
.container{max-width:1600px;margin:auto;}

header{
    background:linear-gradient(135deg,#1f2937,#374151);
    padding:30px;
    border-radius:14px;
    margin-bottom:14px;
}
header h1{color:#84cc16;font-size:32px;}
.subtitle{color:#d1d5db;margin-top:6px;}

.filter-bar{display:flex;margin:10px 0 18px 0;}
.filter-bar select{
    padding:10px 14px;
    border-radius:10px;
    border:2px solid #e5e7eb;
    font-size:14px;
    font-weight:600;
    min-width:220px;
}

.kpi-grid{
    display:grid;
    grid-template-columns:repeat(6,1fr);
    gap:16px;
    margin-bottom:20px;
}
.kpi-card{
    background:#ffffff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:16px;
}
.kpi-card.highlight{border-left:4px solid #84cc16}
.kpi-card.warning{border-left:4px solid #f59e0b}

.kpi-label{
    font-size:11px;
    font-weight:600;
    color:#6b7280;
    text-transform:uppercase;
    margin-bottom:6px;
}
.kpi-value{font-size:22px;font-weight:700;}
.kpi-value.highlight{color:#84cc16}
.kpi-subvalue{font-size:11px;color:#9ca3af;margin-top:4px;}

.chart-row{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:16px;
    margin-bottom:20px;
}

.chart-container {
    background:#ffffff;
    border:2px solid #e5e7eb;
    border-radius:12px;
    padding:15px;
}
.chart-container h3{
    font-size:14px;
    margin-bottom:10px;
    color:#1f2937;
}
canvas{max-height:220px;}

table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{
    border:1px solid #e5e7eb;
    padding:8px;
    font-size:12px;
    text-align:center;
}
th{background:#1f2937;color:white;}

.debug{
    background:#fff3cd;
    padding:10px;
    margin:10px 0;
    border-radius:5px;
    font-size:11px;
}
</style>
</head>

<body>

<aside class="sidebar">
    <h2>Traxion</h2>
    <div class="menu-item active" id="menu-km">üöõ Kil√≥metros</div>
    <div class="menu-item" id="menu-flota">üöó Flota Vehicular</div>
    <div class="menu-item" id="menu-flota2">üöó Dif GPS vs Cargas</div>
</aside>

<main class="content">
<div class="container">

<section id="view-kilometros">

<header>
    <h1>Dashboard de Kil√≥metros Recorridos</h1>
    <p class="subtitle" id="headerPeriodo"></p>
</header>

<div class="filter-bar">
    <select id="unidadNegocio">
        <option value="SETTEPI SALTILLO">SETTEPI SALTILLO</option>
        <option value="LIPU SALTILLO">LIPU SALTILLO</option>
    </select>
</div>

<div class="debug" id="debugInfo" style="display:none;"></div>

<!-- KPIs -->
<div class="kpi-grid">
    <div class="kpi-card highlight">
        <div class="kpi-label">TOTAL KM RECORRIDOS</div>
        <div class="kpi-value highlight" id="kpiTotal">0 km</div>
        <div class="kpi-subvalue">Acumulado del periodo</div>
    </div>

    <div class="kpi-card">
        <div class="kpi-label">KM PERMITIDOS</div>
        <div class="kpi-value" id="kpiPermitido">0 km</div>
        <div class="kpi-subvalue">L√≠mite establecido</div>
    </div>

    <div class="kpi-card highlight">
        <div class="kpi-label">MARGEN DISPONIBLE</div>
        <div class="kpi-value highlight" id="kpiMargen">0 km</div>
        <div class="kpi-subvalue" id="txtMargen"></div>
    </div>

    <div class="kpi-card">
        <div class="kpi-label">KM DE SERVICIO</div>
        <div class="kpi-value" id="kpiServicio">0 km</div>
        <div class="kpi-subvalue" id="pctServicio">0% del total</div>
    </div>

    <div class="kpi-card">
        <div class="kpi-label">KM MTTO / CARGA / RH / SEG</div>
        <div class="kpi-value" id="kpiMtto">0 km</div>
        <div class="kpi-subvalue" id="pctMtto">0% del total</div>
    </div>

    <div class="kpi-card warning">
        <div class="kpi-label">KM INEFICIENTE (VAC√çO)</div>
        <div class="kpi-value" id="kpiVacio">0 km</div>
        <div class="kpi-subvalue" id="pctVacio">0% del total</div>
    </div>
</div>

<!-- Gr√°ficas -->
<div class="chart-row">
    <div class="chart-container">
        <h3>Progreso Acumulado Diario vs Permitido</h3>
        <canvas id="chartProgreso"></canvas>
    </div>

    <div class="chart-container">
        <h3>Distribuci√≥n Total (%)</h3>
        <canvas id="chartDistribucion"></canvas>
    </div>

    <div class="chart-container">
        <h3>Comportamiento Diario</h3>
        <canvas id="chartDiario"></canvas>
    </div>
</div>

<!-- Tabla -->
<div class="chart-container">
<h3>Tabla Consolidada (SOLO UDN seleccionada)</h3>
<table>
<thead>
<tr>
  <th>Gerente</th>
  <th>Jefe</th>
  <th>Cliente</th>
  <th>KM Recorridos</th>
  <th>KM Servicio</th>
  <th>KM Mtto</th>
  <th>KM Ineficiente</th>
  <th>% Vac√≠o</th>
</tr>
</thead>
<tbody id="tablaConsolidada"></tbody>
</table>
</div>

</section>
</div>
</main>

<script>
const SHEET_ID = "1l3QYg7N050BScrtNhKkHQ-hHNDgaK9Prw95Dzb2-DRE";
const SHEET_NAME = "Kilometros";

function num(v){
    if(!v) return 0;
    let str = v.toString().replace(/,/g,"").trim();
    return Number(str) || 0;
}

async function cargarDatos(){
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=${SHEET_NAME}`;
    const res = await fetch(url);
    const csv = await res.text();
    return new Promise(r=>{
        Papa.parse(csv,{header:false,skipEmptyLines:true,complete:x=>r(x.data)});
    });
}

let chartProgreso, chartDistribucion, chartDiario;

async function actualizar(){
    const unidad = unidadNegocio.value.trim();
    const rows = await cargarDatos();

    let total=0, servicio=0, mtto=0, vacio=0, permitidoTotal=0;
    let datosDiarios = [];
    let tablaMap = {};
    let debugLines = [];

    const hoy = new Date();
    const diaActual = hoy.getDate() - 1;

    // Leer KM PERMITIDO TOTAL de fila 7 (√≠ndice 6)
    // AC7 = columna 28 para SETTEPI
    // AD7 = columna 29 para LIPU
    if(rows.length > 6){
        if(unidad === "SETTEPI SALTILLO"){
            permitidoTotal = num(rows[6][28]); // AC7
        } else {
            permitidoTotal = num(rows[6][29]); // AD7
        }
    }

    debugLines.push(`Buscando: ${unidad}`);
    debugLines.push(`D√≠as a procesar: 1 a ${diaActual}`);
    debugLines.push(`Permitido Total: ${permitidoTotal}`);

    // Procesar datos desde fila 8 en adelante
    for(let idx = 7; idx < rows.length; idx++){
        const r = rows[idx];
        
        // Determinar qu√© columnas usar seg√∫n la UDN
        let udnCol, diaCol, totalCol, servCol, mttoCol, vacCol, permCol;
        
        // Buscar en columnas de SETTEPI primero
        const udnSettepi = (r[11]||"").toString().trim();
        const udnLipu = (r[19]||"").toString().trim();
        
        let esSettepi = udnSettepi.toUpperCase().includes("SETTEPI");
        let esLipu = udnLipu.toUpperCase().includes("LIPU");
        
        let kmTotal=0, kmServ=0, kmMtto=0, kmVac=0, kmPermDiario=0, dia=0;
        
        if(esSettepi && unidad === "SETTEPI SALTILLO"){
            dia = num(r[12]);
            kmTotal = num(r[13]); // N
            kmServ  = num(r[14]); // O
            kmMtto  = num(r[15]); // P
            kmVac   = num(r[16]); // Q
            kmPermDiario = num(r[17]); // R
        } 
        else if(esLipu && unidad === "LIPU SALTILLO"){
            dia = num(r[20]);
            kmTotal = num(r[21]); // V
            kmServ  = num(r[22]); // W
            kmMtto  = num(r[23]); // X
            kmVac   = num(r[24]); // Y
            kmPermDiario = num(r[25]); // Z
        }
        
        if(dia >= 1 && dia <= diaActual && kmTotal > 0){
            total += kmTotal;
            servicio += kmServ;
            mtto += kmMtto;
            vacio += kmVac;

            datosDiarios.push({dia, kmTotal, kmServ, kmMtto, kmVac, kmPermDiario});

            // Para la tabla
            const gerente = r[1]||"SIN GERENTE";
            const jefe = r[2]||"SIN JEFE";
            const cliente = r[3]||"SIN CLIENTE";
            const key = gerente+"|"+jefe+"|"+cliente;

            if(!tablaMap[key]){
                tablaMap[key]={gerente,jefe,cliente,rec:0,serv:0,mtto:0,ine:0};
            }

            tablaMap[key].rec += kmTotal;
            tablaMap[key].serv += kmServ;
            tablaMap[key].mtto += kmMtto;
            tablaMap[key].ine += kmVac;
        }
    }

    debugLines.push(`Total procesado: ${total} km`);
    debugLines.push(`Registros en tabla: ${Object.keys(tablaMap).length}`);
    debugLines.push(`D√≠as encontrados: ${datosDiarios.length}`);
    
    document.getElementById('debugInfo').innerHTML = debugLines.join('<br>');
    document.getElementById('debugInfo').style.display = 'block';

    // ====== KPIs ======
    kpiTotal.innerText = total.toLocaleString()+" km";
    kpiServicio.innerText = servicio.toLocaleString()+" km";
    kpiMtto.innerText = mtto.toLocaleString()+" km";
    kpiVacio.innerText = vacio.toLocaleString()+" km";
    kpiPermitido.innerText = permitidoTotal.toLocaleString()+" km";

    // Porcentajes de cada KPI
    const pctServ = total > 0 ? ((servicio/total)*100).toFixed(1) : 0;
    const pctMt = total > 0 ? ((mtto/total)*100).toFixed(1) : 0;
    const pctVac = total > 0 ? ((vacio/total)*100).toFixed(1) : 0;

    pctServicio.innerText = pctServ + "% del total";
    pctMtto.innerText = pctMt + "% del total";
    pctVacio.innerText = pctVac + "% del total";

    // Margen
    const margen = permitidoTotal - total;
    kpiMargen.innerText = margen.toLocaleString()+" km";

    const pctMargen = permitidoTotal > 0 ? ((margen/permitidoTotal)*100).toFixed(1) : 0;
    const importe = (margen*6).toLocaleString("es-MX",{style:"currency",currency:"MXN"});
    txtMargen.innerHTML = `${pctMargen}% de los KM permitidos.<br>Equivale a: ${importe}`;

    headerPeriodo.innerText = "Periodo al d√≠a "+diaActual;

    // ====== GR√ÅFICA 1: Progreso Acumulado ======
    datosDiarios.sort((a,b)=>a.dia-b.dia);

    let labels=[], realAc=0, perAc=0;
    let realData=[], perData=[];

    datosDiarios.forEach(d=>{
        realAc += d.kmTotal;
        perAc += d.kmPermDiario;
        labels.push("D√≠a "+d.dia);
        realData.push(realAc);
        perData.push(perAc);
    });

    if(chartProgreso) chartProgreso.destroy();
    chartProgreso = new Chart(document.getElementById("chartProgreso"),{
        type:"line",
        data:{
            labels,
            datasets:[
                {
                    label:"KM Real Acumulado",
                    data:realData,
                    borderColor:"#84cc16",
                    backgroundColor:"rgba(132,204,22,0.2)",
                    borderWidth:3,
                    tension:0.3,
                    fill:true,
                    pointRadius:4,
                    pointBackgroundColor:"#84cc16"
                },
                {
                    label:"KM Permitido Acumulado",
                    data:perData,
                    borderColor:"#1f2937",
                    backgroundColor:"rgba(31,41,55,0.1)",
                    borderWidth:3,
                    tension:0.3,
                    fill:false,
                    pointRadius:4,
                    pointBackgroundColor:"#1f2937",
                    borderDash:[5,5]
                }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:true,
            plugins:{
                legend:{display:true,position:'top'}
            },
            scales:{
                y:{beginAtZero:true}
            }
        }
    });

    // ====== GR√ÅFICA 2: Distribuci√≥n ======
    if(chartDistribucion) chartDistribucion.destroy();
    chartDistribucion = new Chart(document.getElementById("chartDistribucion"),{
        type:"pie",
        data:{
            labels:["Servicio","Mtto","Vac√≠o"],
            datasets:[{
                data:[servicio, mtto, vacio],
                backgroundColor:["#84cc16","#f59e0b","#ef4444"],
                borderWidth:2,
                borderColor:"#ffffff"
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:true,
            plugins:{
                legend:{display:true,position:'bottom'}
            }
        }
    });

    // ====== GR√ÅFICA 3: Comportamiento Diario ======
    let servDiario=[], mttoDiario=[], vacioDiario=[];
    datosDiarios.forEach(d=>{
        servDiario.push(d.kmServ);
        mttoDiario.push(d.kmMtto);
        vacioDiario.push(d.kmVac);
    });

    if(chartDiario) chartDiario.destroy();
    chartDiario = new Chart(document.getElementById("chartDiario"),{
        type:"line",
        data:{
            labels,
            datasets:[
                {
                    label:"Servicio",
                    data:servDiario,
                    borderColor:"#84cc16",
                    backgroundColor:"rgba(132,204,22,0.1)",
                    borderWidth:2,
                    tension:0.3,
                    fill:true
                },
                {
                    label:"Mtto",
                    data:mttoDiario,
                    borderColor:"#6b7280",
                    backgroundColor:"rgba(107,114,128,0.1)",
                    borderWidth:2,
                    tension:0.3,
                    fill:true
                },
                {
                    label:"Vac√≠o",
                    data:vacioDiario,
                    borderColor:"#ef4444",
                    backgroundColor:"rgba(239,68,68,0.1)",
                    borderWidth:2,
                    tension:0.3,
                    fill:true
                }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:true,
            plugins:{
                legend:{display:true,position:'top'}
            },
            scales:{
                y:{beginAtZero:true}
            }
        }
    });

    // ====== TABLA ======
    let tabla = Object.values(tablaMap).map(r=>{
        let pctVac = r.rec > 0 ? (r.ine/r.rec*100) : 0;
        return {...r, pctVac};
    });

    tabla.sort((a,b)=> b.pctVac - a.pctVac);

    const body = document.getElementById("tablaConsolidada");
    body.innerHTML="";

    tabla.forEach(r=>{
        const rowColor = r.pctVac > 25 ? 'background:#fee2e2;' : '';
        body.innerHTML += `
        <tr style="${rowColor}">
          <td>${r.gerente}</td>
          <td>${r.jefe}</td>
          <td>${r.cliente}</td>
          <td>${r.rec.toLocaleString()}</td>
          <td>${r.serv.toLocaleString()}</td>
          <td>${r.mtto.toLocaleString()}</td>
          <td>${r.ine.toLocaleString()}</td>
          <td><strong>${r.pctVac.toFixed(2)}%</strong></td>
        </tr>`;
    });
}

unidadNegocio.addEventListener("change",actualizar);
actualizar();
</script>

</body>
</html>
