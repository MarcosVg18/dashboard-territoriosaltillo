<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Flota Vehicular | Traxión</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
/* ==== ESTILOS (sin cambios) ==== */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Verdana,sans-serif;background:#f3f4f6;color:#1f2937}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:10px;border-bottom:1px solid #e5e7eb}
th{background:#f9fafb;font-weight:700}
</style>
</head>

<body>

<h2 style="padding:20px">Dashboard Flota Vehicular</h2>

<div style="padding:20px">
<input id="searchVehicleId" placeholder="Buscar Vehicle ID">
<button onclick="buscarVehiculo()">Buscar</button>
</div>

<div style="padding:20px">
<h3>Resumen por Cliente</h3>
<table>
<thead>
<tr>
<th>Cliente</th>
<th>Total</th>
<th>Operando</th>
<th>Mantenimiento</th>
<th>Ineficiencias</th>
<th>Taller</th>
<th>Corralón</th>
<th>% Operando</th>
</tr>
</thead>
<tbody id="tablaDetalle"></tbody>
</table>
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1l3QYg7N050BScrtNhKkHQ-hHNDgaK9Prw95Dzb2-DRE";
const SHEET_NAME = "FlotaVeh";

const STATUS_MAPPING = {
  "Operando": "Operando",
  "Mantenimiento": "Mantenimiento",
  "Alto Rezago Mantenimiento": "Mantenimiento",
  "Ineficiencias": "Ineficiencias",
  "Taller Externo": "Taller Externo",
  "Corralon Grave": "Corralon",
  "Corralon Media": "Corralon"
};

let todosLosVehiculos = [];
let resumenPorCliente = [];

/* ================= DATA ================= */
async function cargarDatos(){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=${SHEET_NAME}`;
  const res = await fetch(url);
  const csv = await res.text();
  return new Promise(r=>{
    Papa.parse(csv,{skipEmptyLines:true,complete:x=>r(x.data)});
  });
}

async function actualizar(){
  const rows = await cargarDatos();
  let clientes = {};

  todosLosVehiculos = [];

  for(let i=1;i<rows.length;i++){
    const r = rows[i];
    if(!r || r.length < 11) continue;

    const udn = r[0]?.trim();
    const vehicleId = r[1]?.trim();
    const cliente = r[2]?.trim();
    const comentario = r[3]?.trim();
    const chasis = r[4]?.trim();
    const marca = r[5]?.trim();
    const modelo = r[6]?.trim();
    const anio = r[7]?.trim();
    const uso = r[8]?.trim();
    const status = r[9]?.trim();
    const aire = r[10]?.trim();

    if(!vehicleId || !cliente) continue;

    const estatusAgrupado = STATUS_MAPPING[status] || status;

    todosLosVehiculos.push({
      vehicleId, cliente, udn, comentario, chasis,
      marca, modelo, anio, uso, status, estatusAgrupado, aire
    });

    if(!clientes[cliente]){
      clientes[cliente] = {
        cliente,
        total:0, operando:0, mantenimiento:0,
        ineficiencias:0, taller:0, corralon:0
      };
    }

    clientes[cliente].total++;

    switch(estatusAgrupado){
      case "Operando": clientes[cliente].operando++; break;
      case "Mantenimiento": clientes[cliente].mantenimiento++; break;
      case "Ineficiencias": clientes[cliente].ineficiencias++; break;
      case "Taller Externo": clientes[cliente].taller++; break;
      case "Corralon": clientes[cliente].corralon++; break;
    }
  }

  resumenPorCliente = Object.values(clientes).sort((a,b)=>b.total-a.total);
  renderizarTabla(resumenPorCliente);
}

/* ================= UI ================= */
function renderizarTabla(data){
  const tbody = document.getElementById("tablaDetalle");
  tbody.innerHTML = "";

  data.forEach(c=>{
    const pct = c.total ? ((c.operando/c.total)*100).toFixed(1) : 0;
    tbody.innerHTML += `
      <tr>
        <td>${c.cliente}</td>
        <td>${c.total}</td>
        <td>${c.operando}</td>
        <td>${c.mantenimiento}</td>
        <td>${c.ineficiencias}</td>
        <td>${c.taller}</td>
        <td>${c.corralon}</td>
        <td>${pct}%</td>
      </tr>
    `;
  });
}

function buscarVehiculo(){
  const id = document.getElementById("searchVehicleId").value.trim();
  const v = todosLosVehiculos.find(x=>x.vehicleId===id);
  if(!v) return alert("No encontrado");
  alert(`Cliente: ${v.cliente}\nStatus: ${v.status}\nModelo: ${v.modelo}`);
}

document.addEventListener("DOMContentLoaded",actualizar);
</script>

</body>
</html>
