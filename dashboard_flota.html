<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Flota Vehicular | Traxi√≥n - DIAGN√ìSTICO</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Segoe UI', Tahoma, Verdana, sans-serif;
  background: #f5f5f5;
  color: #2c2c2c;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.debug-section {
  background: #fff3cd;
  border: 2px solid #ffc107;
  padding: 20px;
  margin: 20px 0;
  border-radius: 8px;
}

.debug-section h3 {
  color: #856404;
  margin-bottom: 10px;
}

.debug-info {
  background: white;
  padding: 10px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 12px;
  white-space: pre-wrap;
  max-height: 400px;
  overflow-y: auto;
}

h2 {
  padding: 20px 0;
  color: #2c2c2c;
  font-weight: 600;
}

.search-box {
  background: white;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-box input {
  padding: 10px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 14px;
  width: 300px;
  margin-right: 10px;
}

.search-box button {
  padding: 10px 20px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: background 0.3s ease;
}

.search-box button:hover {
  background: #218838;
}

.kpis-section {
  background: white;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.kpis-section h3 {
  color: #2c2c2c;
  font-weight: 600;
  margin-bottom: 5px;
}

.kpis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.kpi-card {
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  border: 2px solid #e5e7eb;
}

.kpi-card.operando { background: #d4edda; border-color: #28a745; }
.kpi-card.mantenimiento { background: #fff3cd; border-color: #ffc107; }
.kpi-card.taller { background: #f8d7da; border-color: #dc3545; }
.kpi-card.ineficiencias { background: #ffe5e5; border-color: #c82333; }
.kpi-card.corralon { background: #cfe2ff; border-color: #0d6efd; }

.kpi-label {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  color: #6b7280;
  margin-bottom: 8px;
}

.kpi-value {
  font-size: 32px;
  font-weight: 700;
  color: #2c2c2c;
}

.kpi-percentage {
  font-size: 14px;
  color: #6b7280;
  margin-top: 5px;
}

.table-section {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  overflow-x: auto;
}

.table-section h3 {
  color: #2c2c2c;
  font-weight: 600;
  margin-bottom: 15px;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
}

th {
  background: #f8f9fa;
  font-weight: 700;
  color: #2c2c2c;
  position: sticky;
  top: 0;
}

tr:hover {
  background: #f8f9fa;
}

.status-ok {
  color: #28a745;
  font-weight: bold;
}

.status-error {
  color: #dc3545;
  font-weight: bold;
}
</style>
</head>

<body>

<div class="container">
  <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
    <h2 style="margin: 0; padding: 20px 0;">Dashboard Flota Vehicular - DIAGN√ìSTICO</h2>
  </div>

  <!-- DEBUG SECTION -->
  <div class="debug-section">
    <h3>üîç Informaci√≥n de Diagn√≥stico</h3>
    <div style="margin-bottom: 10px;">
      <strong>Estado de carga:</strong> <span id="loadStatus">Cargando...</span>
    </div>
    <div style="margin-bottom: 10px;">
      <strong>URL consultada:</strong> <span id="urlUsed" style="word-break: break-all;"></span>
    </div>
    <div style="margin-bottom: 10px;">
      <strong>Total de filas recibidas:</strong> <span id="rowCount">0</span>
    </div>
    <div style="margin-bottom: 10px;">
      <strong>Veh√≠culos procesados:</strong> <span id="vehicleCount">0</span>
    </div>
    <button onclick="toggleDebugData()" style="padding: 8px 16px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
      Ver datos crudos (primeras 10 filas)
    </button>
    <div id="debugData" class="debug-info" style="display: none; margin-top: 10px;"></div>
  </div>

  <div class="search-box">
    <input id="searchVehicleId" placeholder="Buscar Vehicle ID" />
    <button onclick="buscarVehiculo()">üîç Buscar</button>
  </div>

  <div class="kpis-section">
    <h3>KPIs Generales</h3>
    <div class="kpis-grid">
      <div class="kpi-card operando">
        <div class="kpi-label">Operando</div>
        <div class="kpi-value" id="kpi-operando">0</div>
        <div class="kpi-percentage" id="kpi-operando-pct">0%</div>
      </div>
      
      <div class="kpi-card mantenimiento">
        <div class="kpi-label">Mantenimiento</div>
        <div class="kpi-value" id="kpi-mantenimiento">0</div>
        <div class="kpi-percentage" id="kpi-mantenimiento-pct">0%</div>
      </div>
      
      <div class="kpi-card taller">
        <div class="kpi-label">Taller Externo</div>
        <div class="kpi-value" id="kpi-taller">0</div>
        <div class="kpi-percentage" id="kpi-taller-pct">0%</div>
      </div>
      
      <div class="kpi-card ineficiencias">
        <div class="kpi-label">Ineficiencias</div>
        <div class="kpi-value" id="kpi-ineficiencias">0</div>
        <div class="kpi-percentage" id="kpi-ineficiencias-pct">0%</div>
      </div>
      
      <div class="kpi-card corralon">
        <div class="kpi-label">Corral√≥n</div>
        <div class="kpi-value" id="kpi-corralon">0</div>
        <div class="kpi-percentage" id="kpi-corralon-pct">0%</div>
      </div>
    </div>
  </div>

  <div class="table-section">
    <h3>Resumen por Cliente</h3>
    <table>
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Total</th>
          <th>Operando</th>
          <th>Mantenimiento</th>
          <th>Taller Externo</th>
          <th>Ineficiencias</th>
          <th>Corral√≥n</th>
          <th>% Operando</th>
        </tr>
      </thead>
      <tbody id="tablaDetalle"></tbody>
    </table>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SHEET_ID = "1l3QYg7N050BScrtNhKkHQ-hHNDgaK9Prw95Dzb2-DRE";
const SHEET_NAME = "FlotaVeh";

const STATUS_MAPPING = {
  "Operando": "Operando",
  "Mantenimiento": "Mantenimiento",
  "Alto Rezago Mantenimiento": "Mantenimiento",
  "Ineficiencias": "Ineficiencias",
  "Taller Externo": "Taller Externo",
  "Corralon Grave": "Corral√≥n",
  "Corralon Media": "Corral√≥n"
};

let todosLosVehiculos = [];
let resumenPorCliente = [];
let kpisGlobales = {
  total: 0,
  operando: 0,
  mantenimiento: 0,
  taller: 0,
  ineficiencias: 0,
  corralon: 0
};

let rawDataRows = [];

/* ================= DEBUG FUNCTIONS ================= */
function toggleDebugData() {
  const debugDiv = document.getElementById('debugData');
  if (debugDiv.style.display === 'none') {
    debugDiv.style.display = 'block';
    
    let debugText = "Primeras 10 filas del CSV:\n\n";
    debugText += "HEADERS:\n";
    if (rawDataRows.length > 0) {
      debugText += JSON.stringify(rawDataRows[0], null, 2) + "\n\n";
    }
    
    debugText += "DATOS:\n";
    for (let i = 1; i < Math.min(11, rawDataRows.length); i++) {
      debugText += `Fila ${i}: ${JSON.stringify(rawDataRows[i], null, 2)}\n`;
    }
    
    debugDiv.textContent = debugText;
  } else {
    debugDiv.style.display = 'none';
  }
}

/* ================= DATA LOADING ================= */
async function cargarDatos() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;
  
  document.getElementById('urlUsed').textContent = url;
  document.getElementById('loadStatus').textContent = 'Consultando Google Sheets...';
  document.getElementById('loadStatus').className = '';
  
  try {
    const res = await fetch(url);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const csv = await res.text();
    
    if (!csv || csv.trim().length === 0) {
      throw new Error('El CSV est√° vac√≠o');
    }
    
    console.log('CSV recibido, primeros 500 caracteres:', csv.substring(0, 500));
    
    return new Promise((resolve, reject) => {
      Papa.parse(csv, {
        skipEmptyLines: true,
        complete: (result) => {
          if (result.errors.length > 0) {
            console.warn('Errores en parsing:', result.errors);
          }
          resolve(result.data);
        },
        error: (error) => {
          reject(error);
        }
      });
    });
  } catch (error) {
    document.getElementById('loadStatus').innerHTML = `<span class="status-error">‚ùå ERROR: ${error.message}</span>`;
    console.error("Error cargando datos:", error);
    alert(`Error al cargar los datos:\n${error.message}\n\n¬øEl Google Sheet est√° compartido p√∫blicamente?`);
    return [];
  }
}

async function actualizar() {
  const rows = await cargarDatos();
  rawDataRows = rows;
  
  document.getElementById('rowCount').textContent = rows.length;
  
  if (rows.length === 0) {
    document.getElementById('loadStatus').innerHTML = '<span class="status-error">‚ùå No se recibieron datos</span>';
    console.error("No se cargaron datos");
    return;
  }
  
  console.log('Total de filas:', rows.length);
  console.log('Headers:', rows[0]);

  let clientes = {};
  todosLosVehiculos = [];
  
  kpisGlobales = {
    total: 0,
    operando: 0,
    mantenimiento: 0,
    taller: 0,
    ineficiencias: 0,
    corralon: 0
  };

  // Procesar cada fila
  let procesados = 0;
  for (let i = 1; i < rows.length; i++) {
    const r = rows[i];
    if (!r || r.length < 11) {
      console.log(`Fila ${i} ignorada (muy corta):`, r);
      continue;
    }

    const udn = r[0]?.trim() || "";
    const vehicleId = r[1]?.trim() || "";
    const cliente = r[2]?.trim() || "";
    const comentario = r[3]?.trim() || "";
    const chasis = r[4]?.trim() || "";
    const marca = r[5]?.trim() || "";
    const modelo = r[6]?.trim() || "";
    const anio = r[7]?.trim() || "";
    const uso = r[8]?.trim() || "";
    const status = r[9]?.trim() || "";
    const aire = r[10]?.trim() || "";

    if (!vehicleId || !cliente) {
      console.log(`Fila ${i} ignorada (sin Vehicle ID o Cliente):`, {vehicleId, cliente});
      continue;
    }

    procesados++;
    
    const estatusAgrupado = STATUS_MAPPING[status] || status;

    todosLosVehiculos.push({
      vehicleId,
      cliente,
      udn,
      comentario,
      chasis,
      marca,
      modelo,
      anio,
      uso,
      status,
      estatusAgrupado,
      aire
    });

    if (!clientes[cliente]) {
      clientes[cliente] = {
        cliente,
        total: 0,
        operando: 0,
        mantenimiento: 0,
        taller: 0,
        ineficiencias: 0,
        corralon: 0
      };
    }

    clientes[cliente].total++;
    kpisGlobales.total++;

    switch (estatusAgrupado) {
      case "Operando":
        clientes[cliente].operando++;
        kpisGlobales.operando++;
        break;
      case "Mantenimiento":
        clientes[cliente].mantenimiento++;
        kpisGlobales.mantenimiento++;
        break;
      case "Taller Externo":
        clientes[cliente].taller++;
        kpisGlobales.taller++;
        break;
      case "Ineficiencias":
        clientes[cliente].ineficiencias++;
        kpisGlobales.ineficiencias++;
        break;
      case "Corral√≥n":
        clientes[cliente].corralon++;
        kpisGlobales.corralon++;
        break;
      default:
        console.warn(`Status no mapeado: "${status}" -> "${estatusAgrupado}"`);
    }
  }

  document.getElementById('vehicleCount').textContent = procesados;
  
  resumenPorCliente = Object.values(clientes).sort((a, b) => b.total - a.total);
  
  renderizarKPIs();
  renderizarTabla(resumenPorCliente);
  
  document.getElementById('loadStatus').innerHTML = `<span class="status-ok">‚úÖ Datos cargados exitosamente</span>`;
  
  console.log(`‚úÖ Datos cargados: ${todosLosVehiculos.length} veh√≠culos, ${resumenPorCliente.length} clientes`);
  console.log('KPIs:', kpisGlobales);
}

/* ================= UI RENDERING ================= */
function renderizarKPIs() {
  const total = kpisGlobales.total || 1;
  
  document.getElementById("kpi-operando").textContent = kpisGlobales.operando;
  document.getElementById("kpi-operando-pct").textContent = 
    `${((kpisGlobales.operando / total) * 100).toFixed(1)}% del total`;
  
  document.getElementById("kpi-mantenimiento").textContent = kpisGlobales.mantenimiento;
  document.getElementById("kpi-mantenimiento-pct").textContent = 
    `${((kpisGlobales.mantenimiento / total) * 100).toFixed(1)}% del total`;
  
  document.getElementById("kpi-taller").textContent = kpisGlobales.taller;
  document.getElementById("kpi-taller-pct").textContent = 
    `${((kpisGlobales.taller / total) * 100).toFixed(1)}% del total`;
  
  document.getElementById("kpi-ineficiencias").textContent = kpisGlobales.ineficiencias;
  document.getElementById("kpi-ineficiencias-pct").textContent = 
    `${((kpisGlobales.ineficiencias / total) * 100).toFixed(1)}% del total`;
  
  document.getElementById("kpi-corralon").textContent = kpisGlobales.corralon;
  document.getElementById("kpi-corralon-pct").textContent = 
    `${((kpisGlobales.corralon / total) * 100).toFixed(1)}% del total`;
}

function renderizarTabla(data) {
  const tbody = document.getElementById("tablaDetalle");
  tbody.innerHTML = "";

  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">No hay datos para mostrar</td></tr>';
    return;
  }

  data.forEach(c => {
    const pctOperando = c.total ? ((c.operando / c.total) * 100).toFixed(1) : 0;
    
    tbody.innerHTML += `
      <tr>
        <td><strong>${c.cliente}</strong></td>
        <td>${c.total}</td>
        <td>${c.operando}</td>
        <td>${c.mantenimiento}</td>
        <td>${c.taller}</td>
        <td>${c.ineficiencias}</td>
        <td>${c.corralon}</td>
        <td><strong>${pctOperando}%</strong></td>
      </tr>
    `;
  });
}

/* ================= SEARCH ================= */
function buscarVehiculo() {
  const id = document.getElementById("searchVehicleId").value.trim();
  
  if (!id) {
    alert("Por favor ingresa un Vehicle ID");
    return;
  }
  
  const v = todosLosVehiculos.find(x => x.vehicleId === id);
  
  if (!v) {
    alert(`No se encontr√≥ el veh√≠culo con ID: ${id}`);
    return;
  }
  
  let info = `VEH√çCULO ENCONTRADO:\n\n`;
  info += `Vehicle ID: ${v.vehicleId}\n`;
  info += `Cliente: ${v.cliente}\n`;
  info += `UDN: ${v.udn}\n`;
  info += `Status: ${v.status}\n`;
  info += `Status Agrupado: ${v.estatusAgrupado}\n`;
  info += `Marca: ${v.marca}\n`;
  info += `Modelo: ${v.modelo}\n`;
  info += `A√±o: ${v.anio}\n`;
  info += `Chasis: ${v.chasis}\n`;
  info += `Uso: ${v.uso}\n`;
  info += `Aire Acondicionado: ${v.aire}\n`;
  if (v.comentario) info += `Comentario: ${v.comentario}\n`;
  
  alert(info);
}

// Permitir b√∫squeda con Enter
document.addEventListener("DOMContentLoaded", () => {
  actualizar();
  
  document.getElementById("searchVehicleId").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
      buscarVehiculo();
    }
  });
});
</script>

</body>
</html>
